<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f4f4; max-width: 600px; margin: 0 auto; }
    .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    h2 { color: #FF6B35; text-align: center; border-bottom: 2px solid #FF6B35; padding-bottom: 10px; }
    label { font-weight: bold; display: block; margin-top: 15px; }
    input, textarea { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; }
    button { width: 100%; padding: 12px; margin-top: 15px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; font-size: 1rem; }
    .btn-main { background: #FF6B35; color: white; }
    .btn-main:disabled { background: #ccc; }
    .btn-sec { background: #eee; color: #333; margin-top: 5px; }
    #result-area { display: none; margin-top: 20px; background: #e8f5e9; padding: 15px; border-radius: 5px; word-break: break-all; }
    .item-preview { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 5px 0; }
  </style>
</head>
<body>

<div class="card">
  <h2>ğŸ¤´ é£Ÿç¥æ§åˆ¶ä¸­å¿ƒ</h2>
  
  <label>åº—å®¶åç¨±</label>
  <input type="text" id="shop-title" placeholder="ä¾‹å¦‚ï¼šé€±äº”åƒé›è…¿">
  
  <label>å¿«é€Ÿè²¼ä¸Šèœå–® (èœå åƒ¹æ ¼)</label>
  <textarea id="paste-area" rows="5" placeholder="æ’éª¨é£¯ 100&#10;é›è…¿é£¯ 110"></textarea>
  <button class="btn-sec" onclick="doSmartParse()">âš¡ï¸ ä¸€éµè½‰æ›</button>
  
  <label>é è¦½èœå–®</label>
  <div id="preview-list" style="background:#fafafa; padding:10px; min-height:50px;">
    <span style="color:#999">ç­‰å¾…è¼¸å…¥...</span>
  </div>

  <button class="btn-main" id="btn-pub" onclick="doPublish()">ğŸš€ ç™¼å¸ƒä¸¦ç”¢ç”Ÿé€£çµ</button>
  
  <div id="result-area"></div>
</div>

<script>
  let menuItems = [];

  // ä¸€éµè½‰æ›é‚è¼¯
  function doSmartParse() {
    const text = document.getElementById('paste-area').value;
    const lines = text.split('\n');
    menuItems = []; // é‡ç½®
    
    lines.forEach(line => {
      const clean = line.trim();
      if (!clean) return;
      // æŠ“æ•¸å­—
      const match = clean.match(/(\d+)/g);
      if (match) {
        const price = match[match.length - 1]; // å–æœ€å¾Œä¸€å€‹æ•¸å­—ç•¶åƒ¹æ ¼
        const name = clean.replace(price, '').replace(/[$.:ï¼š]/g, '').trim();
        if (name && price) {
          menuItems.push({ name: name, price: price });
        }
      }
    });
    
    renderPreview();
  }

  // é¡¯ç¤ºé è¦½
  function renderPreview() {
    const div = document.getElementById('preview-list');
    if (menuItems.length === 0) {
      div.innerHTML = '<span style="color:#999">ç„¡æ³•è¾¨è­˜ï¼Œè«‹ç¢ºèªæ ¼å¼</span>';
      return;
    }
    div.innerHTML = '';
    menuItems.forEach(item => {
      div.innerHTML += `<div class="item-preview"><span>${item.name}</span> <b>$${item.price}</b></div>`;
    });
  }

  // ç™¼å¸ƒ
  function doPublish() {
    const title = document.getElementById('shop-title').value;
    if (!title || menuItems.length === 0) {
      alert("è«‹è¼¸å…¥åº—åä¸¦è‡³å°‘æ–°å¢ä¸€é“èœï¼");
      return;
    }

    const btn = document.getElementById('btn-pub');
    btn.disabled = true;
    btn.innerText = "æ­£åœ¨å»ºç«‹ä¸­...";

    // å‘¼å«å¾Œç«¯
    google.script.run
      .withSuccessHandler(function(res) {
        // å–å¾—ç•¶å‰ç¶²å€ä¸¦åŠ ä¸Š ID
        google.script.run.withSuccessHandler(function(url) {
          const finalLink = url + "?id=" + encodeURIComponent(res.menuId);
          
          document.getElementById('result-area').style.display = 'block';
          document.getElementById('result-area').innerHTML = 
            `âœ… ç™¼å¸ƒæˆåŠŸï¼<br>è«‹è¤‡è£½é€£çµçµ¦åŒäº‹ï¼š<br><br><a href="${finalLink}" target="_blank" style="color:red;font-weight:bold;">${finalLink}</a>`;
          
          btn.innerText = "ç™¼å¸ƒå®Œæˆ";
        }).getScriptUrl();
      })
      .apiCreateMenu({ title: title, items: menuItems });
  }
</script>
</body>
</html>
