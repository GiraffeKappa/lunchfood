<!DOCTYPE html>
<html>
<head>
<base target="_top">
<style>
  body { font-family: 'Microsoft JhengHei', sans-serif; background: #f4f7f6; color: #333; padding: 20px; max-width: 600px; margin: 0 auto; }
  h2 { color: #FF6B35; text-align: center; border-bottom: 2px solid #FF6B35; padding-bottom: 10px; }
  .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
  
  input, textarea, select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
  button { width: 100%; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
  
  .btn-main { background: #FF6B35; color: white; font-size: 1.1rem; }
  .btn-main:disabled { background: #ccc; }
  .btn-sec { background: #eee; color: #333; }
  .btn-del { background: #ffebee; color: red; width: auto; padding: 5px 10px; margin: 0; }
  
  .item-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; }
  .item-row input { margin: 0; }
  
  #link-box { display: none; background: #e8f5e9; padding: 15px; border-radius: 5px; word-break: break-all; margin-top: 15px; }
</style>
</head>
<body>

<h2>ğŸ¤´ é£Ÿç¥æ§åˆ¶ä¸­å¿ƒ</h2>

<div class="card">
  <label>ğŸ“‚ å¿«é€Ÿè¼‰å…¥åº—å®¶</label>
  <select id="pool-select" onchange="loadFromPool()"><option>è¼‰å…¥ä¸­...</option></select>

  <hr style="border:0; border-top:1px dashed #ddd; margin: 15px 0;">

  <label>ğŸ  åº—å®¶åç¨±</label>
  <input type="text" id="menu-title" placeholder="ä¾‹å¦‚ï¼šé€±äº”åƒç‚¸é›">
  
  <label>âœ¨ æ™ºæ…§è²¼ä¸Š (èœå åƒ¹æ ¼)</label>
  <textarea id="smart-area" rows="4" placeholder="æ’éª¨é£¯ 100&#10;é›è…¿é£¯ 110"></textarea>
  <button class="btn-sec" onclick="smartParse()">âš¡ï¸ ä¸€éµè½‰æ›</button>

  <div id="item-list"></div>
  <button class="btn-sec" onclick="addItem()">+ æ‰‹å‹•æ–°å¢ä¸€åˆ—</button>
  
  <div style="margin: 15px 0;">
    <input type="checkbox" id="save-pool" style="width:auto;" checked> 
    <label for="save-pool">åŒæ™‚å­˜å…¥ä¾¿ç•¶æ± </label>
  </div>

  <button class="btn-main" id="btn-pub" onclick="publish()">ğŸš€ ç™¼å¸ƒä¸¦ç”¢ç”Ÿé€£çµ</button>
  
  <div id="link-box"></div>
</div>

<script>
  // åˆå§‹åŒ–
  window.onload = function() {
    google.script.run.withSuccessHandler(renderPool).apiGetPool();
  };

  function renderPool(list) {
    var sel = document.getElementById('pool-select');
    sel.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>';
    list.forEach(function(shop, idx) {
      var opt = document.createElement('option');
      opt.text = shop.title;
      opt.value = JSON.stringify(shop.items);
      sel.add(opt);
    });
  }

  function loadFromPool() {
    var sel = document.getElementById('pool-select');
    if(!sel.value) return;
    document.getElementById('menu-title').value = sel.options[sel.selectedIndex].text;
    var items = JSON.parse(sel.value);
    document.getElementById('item-list').innerHTML = '';
    items.forEach(function(item){ addItem(item.name, item.price); });
  }

  // --- å¼·åŠ›ç‰ˆï¼šæ™ºæ…§è¾¨è­˜ ---
  function smartParse() {
    var textArea = document.getElementById('smart-area');
    var text = textArea.value;
    
    if(!text.trim()) {
       alert("âš ï¸ è«‹å…ˆè²¼ä¸Šèœå–®æ–‡å­—å–”ï¼");
       return;
    }
    
    var lines = text.split('\n'); // ä¾æ›è¡Œåˆ‡å‰²
    var count = 0;
    
    // æ¸…ç©ºç›®å‰çš„åˆ—è¡¨
    document.getElementById('item-list').innerHTML = ''; 
    
    lines.forEach(function(line) {
      var cleanLine = line.trim();
      if(!cleanLine) return; // è·³éç©ºè¡Œ

      // 1. æŠ“å–è¡Œå…§çš„æ‰€æœ‰æ•¸å­—
      var matches = cleanLine.match(/(\d+)/g); 
      
      if(matches) {
        // ç­–ç•¥ï¼šé€šå¸¸åƒ¹æ ¼éƒ½åœ¨æœ€å¾Œé¢ (ä¾‹å¦‚ï¼šæ’éª¨é£¯ 100)ï¼Œä½†ä¹Ÿå¯èƒ½åœ¨æœ€å‰é¢
        // é€™è£¡æˆ‘å€‘å–ã€Œæœ€å¾Œä¸€å€‹å‡ºç¾çš„æ•¸å­—ã€ç•¶ä½œåƒ¹æ ¼
        var price = matches[matches.length - 1]; 
        
        // 2. æŠŠåƒ¹æ ¼å¾å­—ä¸²ä¸­æŒ–æ‰ï¼Œå‰©ä¸‹çš„å°±æ˜¯èœå
        var name = cleanLine.replace(price, '')
                            .replace(/[$.:ï¼šå…ƒNT\s]/g, '') // ç§»é™¤éŒ¢å­—ç¬¦è™Ÿå’Œå¤šé¤˜ç©ºç™½
                            .trim();

        // 3. åªæœ‰ç•¶ èœå å’Œ åƒ¹æ ¼ éƒ½æœ‰æŠ“åˆ°æ™‚æ‰æ–°å¢
        if(name && price) {
          addItem(name, price);
          count++;
        }
      }
    });

    if(count > 0) {
      textArea.value = ''; // æˆåŠŸå¾Œæ¸…ç©ºè¼¸å…¥æ¡†
      // alert("âœ… æˆåŠŸè¾¨è­˜ " + count + " é“èœï¼"); // (å«Œåµå¯è¨»è§£æ‰)
    } else {
      alert("âŒ ç„¡æ³•è¾¨è­˜å…§å®¹ï¼\n\nè«‹ç¢ºèªæ ¼å¼æ˜¯å¦åŒ…å«æ•¸å­—ï¼Œä¾‹å¦‚ï¼š\næ’éª¨é£¯ 100\né›è…¿é£¯ 110");
    }
  }
</script>
</body>
</html>

