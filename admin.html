<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤´ å¤©é¾äººè¨‚é¤ç³»çµ±å¾Œå° (æ¨™æº–ç‰ˆ)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f0f2f5; max-width: 600px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-height: 500px; }
        
        /* é›™åˆ†é æ¨£å¼ */
        .tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; color: #666; transition: 0.3s; }
        .tab-btn:hover { background: #f9f9f9; }
        .tab-btn.active { color: #FF6B35; border-bottom: 3px solid #FF6B35; background: #fff; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h2 { text-align: center; color: #FF6B35; margin-top: 0; }
        label { display: block; margin: 15px 0 5px; font-weight: bold; color: #333; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        
        .btn-main { background: #FF6B35; color: white; }
        .btn-sec { background: #e4e6eb; color: #333; }
        .btn-rand { background: #9C27B0; color: white; } 

        .item-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .del-btn { background: #ffebee; color: red; width: auto; padding: 0 15px; }
        #result-box { display: none; background: #e8f5e9; padding: 15px; margin-top: 20px; border-radius: 8px; word-break: break-all; }
        
        .order-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .order-info { flex-grow: 1; }
        .order-name { font-weight: bold; font-size: 1.1rem; }
        .order-detail { color: #666; font-size: 0.9rem; }
        .pay-btn { width: auto; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; margin: 0; }
        .status-unpaid { background: #eee; color: #666; }
        .status-paid { background: #4CAF50; color: white; }
        .summary-box { background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-weight: bold; color: #d84315; }
    </style>
</head>
<body>

<div class="card">
    <div class="tabs">
        <div class="tab-btn active" onclick="switchTab('create')">ğŸš€ ç™¼å¸ƒèœå–®</div>
        <div class="tab-btn" onclick="switchTab('manage')">ğŸ’° æ”¶æ¬¾ç®¡ç†</div>
    </div>

    <div id="tab-create" class="tab-content active">
        <h2>å»ºç«‹æ–°è¨‚é¤</h2>
        <label>ğŸ“‚ å¾ä¾¿ç•¶æ± è¼‰å…¥</label>
        <select id="pool-select" onchange="loadFromPool()"><option value="">è¼‰å…¥ä¸­...</option></select>
        <button class="btn-rand" onclick="randomPick()">ğŸ² éš¨æ©Ÿé¸ä¸€å€‹åº—å®¶</button>

        <label>ğŸ  åº—å®¶åç¨±</label>
        <input type="text" id="shop-title" placeholder="ä¾‹å¦‚ï¼šå¿«æ¨‚ä¾¿ç•¶">

        <label>ğŸ“ æ™ºæ…§è²¼ä¸Š</label>
        <textarea id="paste-area" rows="3" placeholder="æ’éª¨é£¯ 100&#10;é›è…¿é£¯ 110"></textarea>
        <button class="btn-sec" onclick="smartParse()">ğŸª„ ä¸€éµè½‰æ›</button>

        <div id="item-list" style="margin-top:10px"></div>
        <button class="btn-sec" onclick="addItem()">+ æ‰‹å‹•æ–°å¢</button>
        
        <div style="margin-top:15px;">
            <input type="checkbox" id="save-pool" checked style="width:auto;"> <label for="save-pool" style="display:inline;">å­˜å…¥ä¾¿ç•¶æ± </label>
        </div>

        <button class="btn-main" id="btn-pub" onclick="publish()" style="margin-top:20px;">ğŸš€ ç™¼å¸ƒä¸¦ç”¢ç”Ÿé€£çµ</button>
        <div id="result-box"></div>
    </div>

    <div id="tab-manage" class="tab-content">
        <h2>æ”¶æ¬¾ç›£æ§</h2>
        <label>é¸æ“‡è¦æŸ¥å¸³çš„åœ˜è³¼</label>
        <select id="sheet-select" onchange="loadOrders()">
            <option value="">-- è«‹é¸æ“‡ --</option>
        </select>
        <button class="btn-sec" onclick="loadSheetList()">ğŸ”„ é‡æ–°æ•´ç†åˆ—è¡¨</button>

        <div id="summary-area" class="summary-box" style="display:none"></div>
        <div id="order-list"></div>
    </div>
</div>

<script>
    // âš ï¸âš ï¸âš ï¸ è«‹ç¢ºèªé€™è£¡æ˜¯æ‚¨æ­£ç¢ºçš„ GAS ç¶²å€ âš ï¸âš ï¸âš ï¸
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzCUFGnwpcfsjg6aL7fYHyzglS9MJ18FBbgzNQh42e6KvAVS7-jmRZnEiBcDLSA2TGbEA/exec";

    window.onload = function() {
        fetchPool();
    };

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        if (tab === 'create') {
            document.getElementById('tab-create').classList.add('active');
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
        } else {
            document.getElementById('tab-manage').classList.add('active');
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
            loadSheetList(); 
        }
    }

    // --- Part 1: ç™¼å¸ƒåŠŸèƒ½ ---
    function fetchPool() {
        fetch(GAS_URL + "?action=get_pool")
        .then(res=>res.json())
        .then(data => {
            const sel = document.getElementById('pool-select');
            sel.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>';
            if(data.data) data.data.forEach(shop => sel.add(new Option(shop.title, JSON.stringify(shop.items))));
        });
    }

    function randomPick() {
        const sel = document.getElementById('pool-select');
        const options = sel.options;
        if (options.length <= 1) return alert("ä¾¿ç•¶æ± æ˜¯ç©ºçš„ï¼");
        const randIndex = Math.floor(Math.random() * (options.length - 1)) + 1;
        sel.selectedIndex = randIndex;
        loadFromPool();
        alert("ğŸ² é¸ä¸­ï¼š" + sel.options[randIndex].text);
    }

    function loadFromPool() {
        const sel = document.getElementById('pool-select');
        if(!sel.value) return;
        document.getElementById('shop-title').value = sel.options[sel.selectedIndex].text;
        document.getElementById('item-list').innerHTML = '';
        JSON.parse(sel.value).forEach(i => addItem(i.name, i.price));
        document.getElementById('save-pool').checked = false;
    }

    function smartParse() {
        const text = document.getElementById('paste-area').value;
        const lines = text.split('\n');
        document.getElementById('item-list').innerHTML = ''; 
        lines.forEach(line => {
            const match = line.trim().match(/(\d+)/g);
            if(match) {
                const price = match[match.length - 1];
                const name = line.trim().replace(price, '').replace(/[$.:ï¼šå…ƒNT\s]/g, '').trim();
                if(name && price) addItem(name, price);
            }
        });
        document.getElementById('paste-area').value = '';
        document.getElementById('save-pool').checked = true;
    }

    function addItem(name='', price='') {
        const div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = `<input type="text" class="name" value="${name}" placeholder="èœå"><input type="number" class="price" value="${price}" placeholder="$" style="width:80px"><button class="del-btn" onclick="this.parentElement.remove()">Ã—</button>`;
        document.getElementById('item-list').appendChild(div);
    }

    function publish() {
        const title = document.getElementById('shop-title').value;
        const items = [];
        document.querySelectorAll('.item-row').forEach(r => {
            const n = r.querySelector('.name').value;
            const p = r.querySelector('.price').value;
            if(n && p) items.push({name: n, price: p});
        });

        if(!title || items.length === 0) return alert("è³‡æ–™ä¸å®Œæ•´");
        
        const btn = document.getElementById('btn-pub');
        btn.innerText = "è™•ç†ä¸­...";
        btn.disabled = true;

        fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'create_menu', title: title, items: items, saveToPool: document.getElementById('save-pool').checked })
        }).then(res => res.json()).then(json => {
            if(json.status === 'success') {
                let link = window.location.href.replace('admin.html', '') + 'index.html?id=' + json.menuId;
                link = link.replace('//index.html', '/index.html');
                document.getElementById('result-box').style.display = 'block';
                document.getElementById('result-box').innerHTML = `âœ… ç™¼å¸ƒæˆåŠŸï¼<br><a href="${link}" target="_blank" style="color:red;font-weight:bold;">${link}</a>`;
                btn.innerText = "ç™¼å¸ƒå®Œæˆ";
            } else {
                alert("å¤±æ•—ï¼š" + json.message);
                btn.disabled = false;
            }
        });
    }

    // --- Part 2: æŸ¥å¸³åŠŸèƒ½ ---
    function loadSheetList() {
        const sel = document.getElementById('sheet-select');
        sel.innerHTML = '<option>è¼‰å…¥ä¸­...</option>';
        fetch(GAS_URL + "?action=get_sheets")
        .then(res => res.json())
        .then(data => {
            sel.innerHTML = '<option value="">-- è«‹é¸æ“‡è¦æŸ¥å¸³çš„åœ˜ --</option>';
            if(data.data) {
                const list = [...data.data].reverse();
                list.forEach(name => {
                    const parts = name.split('_');
                    const dateStr = parts[0].slice(4, 8);
                    let displayName = "";
                    if (parts.length >= 3) {
                        const shopName = parts.slice(2).join('_');
                        displayName = `${shopName} (${dateStr})`;
                    } else {
                        const timeStr = parts[1] || "";
                        displayName = `(ç„¡åº—å) ${timeStr} (${dateStr})`;
                    }
                    sel.add(new Option(displayName, name));
                });
            }
        });
    }

    function loadOrders() {
        const menuId = document.getElementById('sheet-select').value;
        if(!menuId) return;

        const list = document.getElementById('order-list');
        list.innerHTML = '<p style="text-align:center">è¼‰å…¥ä¸­...</p>';

        fetch(GAS_URL + "?action=get_orders&menuId=" + menuId)
        .then(res => res.json())
        .then(data => {
            list.innerHTML = '';
            if(data.status === 'success' && data.orders) {
                let totalMoney = 0;
                let paidMoney = 0;

                data.orders.forEach(order => {
                    let price = parseInt(order.price) || 0;
                    totalMoney += price;
                    if(order.paid) paidMoney += price;

                    const div = document.createElement('div');
                    div.className = 'order-row';
                    const btnClass = order.paid ? 'status-paid' : 'status-unpaid';
                    const btnText = order.paid ? 'âœ… å·²ä»˜' : 'æœªä»˜';
                    
                    div.innerHTML = `
                        <div class="order-info">
                            <div class="order-name">${order.name}</div>
                            <div class="order-detail" style="color:#d32f2f; font-weight:bold;">${order.item}</div>
                            <div class="order-detail">ç¸½è¨ˆ $${price} | ${order.note || ''}</div>
                        </div>
                        <button class="pay-btn ${btnClass}" onclick="togglePay('${menuId}', ${order.row}, this, ${price})">${btnText}</button>
                    `;
                    list.appendChild(div);
                });

                const summary = document.getElementById('summary-area');
                summary.style.display = 'block';
                summary.innerHTML = `ç¸½é‡‘é¡ï¼š$${totalMoney} / å·²æ”¶ï¼š$${paidMoney} / æœªæ”¶ï¼š$${totalMoney - paidMoney}`;
                
                if(data.orders.length === 0) list.innerHTML = '<p style="text-align:center;color:#666">ç›®å‰ç„¡è¨‚å–®</p>';
            } else {
                 list.innerHTML = '<p style="text-align:center;color:red">è®€å–å¤±æ•—</p>';
            }
        });
    }

    function togglePay(menuId, row, btn, price) {
        btn.disabled = true;
        btn.innerText = 'æ›´æ–°ä¸­...';
        fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'toggle_payment', menuId: menuId, row: row })
        }).then(res => res.json()).then(json => {
            btn.disabled = false;
            if(json.status === 'success') {
                loadOrders(); 
            } else {
                alert("å¤±æ•—");
                btn.innerText = 'é‡è©¦';
            }
        });
    }
</script>
</body>
</html>

