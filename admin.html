<!DOCTYPE html>
<html>
<head>
<base target="_top">
<style>
  body { font-family: 'Microsoft JhengHei', sans-serif; background: #f4f7f6; color: #333; padding: 20px; max-width: 600px; margin: 0 auto; }
  h2 { color: #FF6B35; text-align: center; border-bottom: 2px solid #FF6B35; padding-bottom: 10px; }
  .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
  
  input, textarea, select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
  button { width: 100%; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
  
  .btn-main { background: #FF6B35; color: white; font-size: 1.1rem; }
  .btn-main:disabled { background: #ccc; }
  .btn-sec { background: #eee; color: #333; }
  .btn-del { background: #ffebee; color: red; width: auto; padding: 5px 10px; margin: 0; }
  
  .item-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; }
  .item-row input { margin: 0; }
  
  #link-box { display: none; background: #e8f5e9; padding: 15px; border-radius: 5px; word-break: break-all; margin-top: 15px; }
</style>
</head>
<body>

<h2>ğŸ¤´ é£Ÿç¥æ§åˆ¶ä¸­å¿ƒ</h2>

<div class="card">
  <label>ğŸ“‚ å¿«é€Ÿè¼‰å…¥åº—å®¶</label>
  <select id="pool-select" onchange="loadFromPool()"><option>è¼‰å…¥ä¸­...</option></select>

  <hr style="border:0; border-top:1px dashed #ddd; margin: 15px 0;">

  <label>ğŸ  åº—å®¶åç¨±</label>
  <input type="text" id="menu-title" placeholder="ä¾‹å¦‚ï¼šé€±äº”åƒç‚¸é›">
  
  <label>âœ¨ æ™ºæ…§è²¼ä¸Š (èœå åƒ¹æ ¼)</label>
  <textarea id="smart-area" rows="4" placeholder="æ’éª¨é£¯ 100&#10;é›è…¿é£¯ 110"></textarea>
  <button class="btn-sec" onclick="smartParse()">âš¡ï¸ ä¸€éµè½‰æ›</button>

  <div id="item-list"></div>
  <button class="btn-sec" onclick="addItem()">+ æ‰‹å‹•æ–°å¢ä¸€åˆ—</button>
  
  <div style="margin: 15px 0;">
    <input type="checkbox" id="save-pool" style="width:auto;" checked> 
    <label for="save-pool">åŒæ™‚å­˜å…¥ä¾¿ç•¶æ± </label>
  </div>

  <button class="btn-main" id="btn-pub" onclick="publish()">ğŸš€ ç™¼å¸ƒä¸¦ç”¢ç”Ÿé€£çµ</button>
  
  <div id="link-box"></div>
</div>

<script>
  // åˆå§‹åŒ–
  window.onload = function() {
    google.script.run.withSuccessHandler(renderPool).apiGetPool();
  };

  function renderPool(list) {
    var sel = document.getElementById('pool-select');
    sel.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>';
    list.forEach(function(shop, idx) {
      var opt = document.createElement('option');
      opt.text = shop.title;
      opt.value = JSON.stringify(shop.items);
      sel.add(opt);
    });
  }

  function loadFromPool() {
    var sel = document.getElementById('pool-select');
    if(!sel.value) return;
    document.getElementById('menu-title').value = sel.options[sel.selectedIndex].text;
    var items = JSON.parse(sel.value);
    document.getElementById('item-list').innerHTML = '';
    items.forEach(function(item){ addItem(item.name, item.price); });
  }

  // 1. æ™ºæ…§è¾¨è­˜ (ä¿®æ­£ç‰ˆ)
  function smartParse() {
    var text = document.getElementById('smart-area').value;
    if(!text) return alert("è«‹å…ˆè²¼ä¸Šæ–‡å­—");
    
    var lines = text.split('\n');
    document.getElementById('item-list').innerHTML = ''; // æ¸…ç©º
    
    lines.forEach(function(line) {
      var clean = line.trim();
      if(!clean) return;
      var match = clean.match(/(\d+)/g); // æŠ“å–æ•¸å­—
      if(match) {
        var price = match[match.length - 1]; // æœ€å¾Œä¸€å€‹æ•¸å­—ç•¶åƒ¹æ ¼
        var name = clean.replace(price, '').replace(/[$.:ï¼š]/g,'').trim();
        if(name && price) addItem(name, price);
      }
    });
    document.getElementById('smart-area').value = '';
  }

  // 2. æ‰‹å‹•æ–°å¢
  function addItem(name='', price='') {
    var div = document.createElement('div');
    div.className = 'item-row';
    div.innerHTML = `
      <input type="text" class="name" value="${name}" placeholder="èœå">
      <input type="number" class="price" value="${price}" placeholder="$" style="width:80px;">
      <button class="btn-del" onclick="this.parentElement.remove()">Ã—</button>
    `;
    document.getElementById('item-list').appendChild(div);
  }

  // 3. ç™¼å¸ƒ (ä½¿ç”¨ google.script.runï¼Œæœ€ç©©å®šï¼)
  function publish() {
    var title = document.getElementById('menu-title').value;
    var rows = document.querySelectorAll('.item-row');
    var items = [];
    
    rows.forEach(function(row) {
      var n = row.querySelector('.name').value;
      var p = row.querySelector('.price').value;
      if(n && p) items.push({name: n, price: p});
    });

    if(!title || items.length === 0) return alert("è«‹è¼¸å…¥åº—åä¸¦è‡³å°‘ä¸€é“èœ");

    var btn = document.getElementById('btn-pub');
    btn.disabled = true;
    btn.innerText = "è™•ç†ä¸­...";

    var data = {
      title: title,
      items: items,
      saveToPool: document.getElementById('save-pool').checked
    };

    google.script.run
      .withSuccessHandler(function(res) {
         btn.innerText = "ç™¼å¸ƒå®Œæˆï¼";
         var url = <?= ScriptApp.getService().getUrl() ?>; // è‡ªå‹•å–å¾—ç•¶å‰ç¶²å€
         var finalLink = url + "?id=" + encodeURIComponent(res.menuId);
         
         document.getElementById('link-box').style.display = 'block';
         document.getElementById('link-box').innerHTML = 
           'âœ… é€£çµå·²ç”¢ç”Ÿï¼š<br><a href="' + finalLink + '" target="_blank">' + finalLink + '</a>';
         
         if(data.saveToPool) google.script.run.withSuccessHandler(renderPool).apiGetPool(); // é‡æ•´é¸å–®
      })
      .withFailureHandler(function(err) {
         alert("éŒ¯èª¤ï¼š" + err);
         btn.disabled = false;
      })
      .apiCreateMenu(data);
  }
</script>
</body>
</html>
