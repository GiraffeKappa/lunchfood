<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤´ é£Ÿç¥å¾Œå° (GitHubç‰ˆ)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; max-width: 600px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #FF6B35; border-bottom: 2px solid #FF6B35; padding-bottom: 15px; }
        label { display: block; margin: 15px 0 5px; font-weight: bold; color: #333; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; }
        .btn-main { background: #FF6B35; color: white; }
        .btn-main:hover { background: #e55a2b; }
        .btn-sec { background: #e4e6eb; color: #333; }
        .item-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .del-btn { background: #ffebee; color: red; width: auto; padding: 0 15px; }
        #result-box { display: none; background: #e8f5e9; padding: 15px; margin-top: 20px; border-radius: 8px; word-break: break-all; }
    </style>
</head>
<body>

<div class="card">
    <h2>âš¡ï¸ å¤©é¾äººè¨‚é¤ç³»çµ±</h2>
    
    <label>ğŸ“‚ å¾ä¾¿ç•¶æ± è¼‰å…¥</label>
    <select id="pool-select" onchange="loadFromPool()"><option>è¼‰å…¥ä¸­...</option></select>

    <label>ğŸ  åº—å®¶åç¨±</label>
    <input type="text" id="shop-title" placeholder="ä¾‹å¦‚ï¼šå¿«æ¨‚ä¾¿ç•¶">

    <label>ğŸ“ æ™ºæ…§è²¼ä¸Š (èœå åƒ¹æ ¼)</label>
    <textarea id="paste-area" rows="4" placeholder="æ’éª¨é£¯ 100&#10;é›è…¿é£¯ 110"></textarea>
    <button class="btn-sec" onclick="smartParse()">ğŸª„ ä¸€éµè½‰æ›</button>

    <label>ğŸ“‹ èœå–®é è¦½</label>
    <div id="item-list"></div>
    <button class="btn-sec" onclick="addItem()">+ æ‰‹å‹•æ–°å¢</button>
    
    <div style="margin-top:15px;">
        <input type="checkbox" id="save-pool" checked style="width:auto;"> 
        <label for="save-pool" style="display:inline;">å­˜å…¥ä¾¿ç•¶æ± </label>
    </div>

    <button class="btn-main" id="btn-pub" onclick="publish()" style="margin-top:20px;">ğŸš€ ç™¼å¸ƒä¸¦ç”¢ç”Ÿé€£çµ</button>
    
    <div id="result-box"></div>
</div>

<script>
    // âš ï¸âš ï¸âš ï¸ è«‹å¡«å…¥ä½ çš„ GAS ç¶²å€ âš ï¸âš ï¸âš ï¸
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxPpLknsRM3J8S57MbhNRUhST9CQfqyxjKoaGT1ePz_lUAlE-XMTjEx-YEN-BeyfIDrKg/exec";

    // åˆå§‹åŒ–
    window.onload = function() {
        if(GAS_URL.includes("ä½ çš„_GAS")) alert("è«‹è¨˜å¾—ä¿®æ”¹ admin.html è£¡çš„ GAS_URLï¼");
        fetchPool();
    };

    // 1. æ™ºæ…§è¾¨è­˜ (æœ€å¼·ç‰ˆ)
    function smartParse() {
        const text = document.getElementById('paste-area').value;
        if(!text.trim()) return alert("è«‹å…ˆè²¼ä¸Šæ–‡å­—ï¼");
        
        const lines = text.split('\n');
        document.getElementById('item-list').innerHTML = ''; // æ¸…ç©º
        
        lines.forEach(line => {
            const clean = line.trim();
            if(!clean) return;
            const match = clean.match(/(\d+)/g);
            if(match) {
                const price = match[match.length - 1]; // å–æœ€å¾Œä¸€å€‹æ•¸å­—
                const name = clean.replace(price, '').replace(/[$.:ï¼šå…ƒNT\s]/g, '').trim();
                if(name && price) addItem(name, price);
            }
        });
        document.getElementById('paste-area').value = '';
    }

    // 2. æ‰‹å‹•æ–°å¢ UI
    function addItem(name='', price='') {
        const div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = `
            <input type="text" class="name" value="${name}" placeholder="èœå">
            <input type="number" class="price" value="${price}" placeholder="$" style="width:80px">
            <button class="del-btn" onclick="this.parentElement.remove()">Ã—</button>
        `;
        document.getElementById('item-list').appendChild(div);
    }

    // 3. è®€å–ä¾¿ç•¶æ±  (GET)
    function fetchPool() {
        fetch(GAS_URL + "?action=get_pool")
        .then(res => res.json())
        .then(data => {
            const sel = document.getElementById('pool-select');
            sel.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>';
            if(data.data) {
                data.data.forEach(shop => {
                    let opt = new Option(shop.title, JSON.stringify(shop.items));
                    sel.add(opt);
                });
            }
        });
    }

    function loadFromPool() {
        const sel = document.getElementById('pool-select');
        if(!sel.value) return;
        document.getElementById('shop-title').value = sel.options[sel.selectedIndex].text;
        document.getElementById('item-list').innerHTML = '';
        JSON.parse(sel.value).forEach(i => addItem(i.name, i.price));
    }

    // 4. ç™¼å¸ƒ (POST)
    function publish() {
        const title = document.getElementById('shop-title').value;
        const items = [];
        document.querySelectorAll('.item-row').forEach(row => {
            const n = row.querySelector('.name').value;
            const p = row.querySelector('.price').value;
            if(n && p) items.push({name: n, price: p});
        });

        if(!title || items.length === 0) return alert("è³‡æ–™ä¸å®Œæ•´ï¼");

        const btn = document.getElementById('btn-pub');
        btn.disabled = true;
        btn.innerText = "ç™¼å¸ƒä¸­...";

        const payload = {
            action: 'create_menu',
            title: title,
            items: items,
            saveToPool: document.getElementById('save-pool').checked
        };

        // ä½¿ç”¨ fetch POST ç™¼é€ JSON
        fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(json => {
            if(json.status === 'success') {
                // è‡ªå‹•åµæ¸¬ GitHub ç¶²å€ï¼Œä¸¦æŠŠ admin.html æ›æˆ index.html
                let userLink = window.location.href.replace('admin.html', '') + 'index.html?id=' + json.menuId;
                // ä¿®æ­£å¯èƒ½å¤šé¤˜çš„æ–œç·š
                userLink = userLink.replace('//index.html', '/index.html'); 

                document.getElementById('result-box').style.display = 'block';
                document.getElementById('result-box').innerHTML = 
                    `âœ… <b>ç™¼å¸ƒæˆåŠŸï¼</b><br>è«‹è¤‡è£½æ­¤é€£çµçµ¦ Userï¼š<br><br><a href="${userLink}" target="_blank" style="color:red;font-weight:bold;">${userLink}</a>`;
                
                btn.innerText = "ç™¼å¸ƒå®Œæˆ";
                if(payload.saveToPool) setTimeout(fetchPool, 1000);
            } else {
                alert("éŒ¯èª¤ï¼š" + json.message);
                btn.disabled = false;
            }
        })
        .catch(err => {
            alert("é€£ç·šå¤±æ•—ï¼è«‹æª¢æŸ¥ GAS_URL");
            console.error(err);
            btn.disabled = false;
        });
    }
</script>
</body>
</html>

